<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üì± –î–Ω–µ–≤–Ω–æ–π –æ—Ç—á—ë—Ç</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--tg-theme-bg-color, #f5f5f5);
            color: var(--tg-theme-text-color, #000);
            padding: 16px;
            padding-bottom: 80px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 24px;
            padding: 16px;
            background: var(--tg-theme-secondary-bg-color, #fff);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .section {
            background: var(--tg-theme-secondary-bg-color, #fff);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--tg-theme-link-color, #2481cc);
        }

        .form-group {
            margin-bottom: 16px;
        }

        label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--tg-theme-hint-color, #999);
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            background: var(--tg-theme-bg-color, #fff);
            color: var(--tg-theme-text-color, #000);
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--tg-theme-button-color, #2481cc);
        }

        .payment-item, .expense-item, .income-item {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
            padding: 12px;
            background: var(--tg-theme-bg-color, #f9f9f9);
            border-radius: 8px;
        }

        .payment-item label, .expense-item label, .income-item label {
            flex: 1;
            margin: 0;
        }

        .payment-item input, .expense-item input, .income-item input {
            flex: 2;
            min-width: 120px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.3s;
        }

        .btn:active {
            opacity: 0.7;
        }

        .btn-primary {
            background: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #fff);
            width: 100%;
        }

        .btn-add {
            background: #4CAF50;
            color: white;
            width: 100%;
            margin-top: 8px;
        }

        .btn-remove {
            background: #f44336;
            color: white;
            padding: 8px 16px;
            font-size: 14px;
        }

        .info-text {
            font-size: 14px;
            color: var(--tg-theme-hint-color, #999);
            margin-top: 8px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            font-size: 18px;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .success {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .dynamic-list {
            margin-top: 12px;
        }

        .list-item {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            align-items: flex-start;
        }

        .list-item input,
        .list-item select {
            flex: 1;
        }

        #totalSales {
            font-size: 20px;
            font-weight: bold;
            color: var(--tg-theme-button-color, #2481cc);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì± –î–Ω–µ–≤–Ω–æ–π –æ—Ç—á—ë—Ç</h1>
            <p id="dateDisplay"></p>
        </div>

        <div id="message"></div>

        <!-- –û–°–ù–û–í–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø -->
        <div class="section">
            <div class="section-title">üìã –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</div>
            
            <div class="form-group">
                <label>–î–∞—Ç–∞ –æ—Ç—á—ë—Ç–∞</label>
                <input type="date" id="reportDate" required>
            </div>

            <div class="form-group">
                <label>–¢–æ—á–∫–∞ –ø—Ä–æ–¥–∞–∂</label>
                <select id="location" required>
                    <option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>
                </select>
            </div>

            <div class="form-group">
                <label>–û–±—â–∞—è —Å—É–º–º–∞ –ø—Ä–æ–¥–∞–∂ (—Å—É–º)</label>
                <input type="number" id="totalSales" placeholder="0" required>
            </div>
        </div>

        <!-- –ú–ï–¢–û–î–´ –û–ü–õ–ê–¢–´ -->
        <div class="section">
            <div class="section-title">üí≥ –ú–µ—Ç–æ–¥—ã –æ–ø–ª–∞—Ç—ã</div>
            <div id="paymentMethods"></div>
        </div>

        <!-- –†–ê–°–•–û–î–´ -->
        <div class="section">
            <div class="section-title">üí∏ –†–∞—Å—Ö–æ–¥—ã</div>
            <div id="expenses"></div>
            <button class="btn btn-add" onclick="addExpense()">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥</button>
        </div>

        <!-- –ü–†–ò–•–û–î–´ -->
        <div class="section">
            <div class="section-title">üí∞ –ü—Ä–∏—Ö–æ–¥—ã (–Ω–µ –æ—Ç –ø—Ä–æ–¥–∞–∂)</div>
            <div id="incomes"></div>
            <button class="btn btn-add" onclick="addIncome()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏—Ö–æ–¥</button>
        </div>

        <!-- –ù–ê–õ–ò–ß–ù–´–ï -->
        <div class="section">
            <div class="section-title">üíµ –ù–∞–ª–∏—á–Ω—ã–µ (—Ñ–∞–∫—Ç)</div>
            <div class="form-group">
                <label>–°—É–º–º–∞ –Ω–∞–ª–∏—á–Ω—ã—Ö (–ø–æ—Å—á–∏—Ç–∞–ª–∏ –∫—É–ø—é—Ä—ã)</label>
                <input type="number" id="cashActual" placeholder="0">
                <p class="info-text">–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –∫–æ—Ç–æ—Ä—É—é –ø–æ—Å—á–∏—Ç–∞–ª–∏ –≤ –∫–∞—Å—Å–µ</p>
            </div>
        </div>

        <!-- –ö–ù–û–ü–ö–ê –°–û–•–†–ê–ù–ï–ù–ò–Ø -->
        <button class="btn btn-primary" onclick="saveReport()">üíæ –°–û–•–†–ê–ù–ò–¢–¨ –û–¢–ß–Å–¢</button>
    </div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App (—Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π)
        const tg = window.Telegram?.WebApp || {
            expand: () => {},
            ready: () => {},
            showAlert: (msg, callback) => { alert(msg); callback?.(); },
            close: () => { console.log('Close'); },
            initDataUnsafe: {}
        };
        tg.expand();
        tg.ready();

        // API URL (–ø–æ–º–µ–Ω—è–π –Ω–∞ —Å–≤–æ–π —Å–µ—Ä–≤–µ—Ä!)
        const API_URL = 'http://localhost:8000';

        // –î–∞–Ω–Ω—ã–µ
        let locations = [];
        let paymentMethods = [];
        let expenseCategories = [];
        let incomeCategories = [];
        let expenseCount = 0;
        let incomeCount = 0;

        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–µ–∫—É—â–µ–π –¥–∞—Ç—ã
        document.getElementById('reportDate').valueAsDate = new Date();
        document.getElementById('dateDisplay').textContent = new Date().toLocaleDateString('ru-RU');

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        async function loadData() {
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏
                const [locsRes, methodsRes, expCatsRes, incCatsRes] = await Promise.all([
                    fetch(`${API_URL}/api/locations`),
                    fetch(`${API_URL}/api/payment_methods`),
                    fetch(`${API_URL}/api/expense_categories`),
                    fetch(`${API_URL}/api/income_categories`)
                ]);

                locations = (await locsRes.json()).data;
                paymentMethods = (await methodsRes.json()).data;
                expenseCategories = (await expCatsRes.json()).data;
                incomeCategories = (await incCatsRes.json()).data;

                // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ç–æ—á–∫–∏
                const locSelect = document.getElementById('location');
                locSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—á–∫—É</option>';
                locations.forEach(loc => {
                    locSelect.innerHTML += `<option value="${loc.id}">${loc.name}</option>`;
                });

                // –ó–∞–ø–æ–ª–Ω—è–µ–º –º–µ—Ç–æ–¥—ã –æ–ø–ª–∞—Ç—ã (—Ç–æ–ª—å–∫–æ –≤–∏–¥–∏–º—ã–µ, –ø–æ –ø–æ—Ä—è–¥–∫—É)
                const methodsDiv = document.getElementById('paymentMethods');
                paymentMethods
                    .filter(m => m.is_visible && m.is_active)
                    .sort((a, b) => (a.display_order || 0) - (b.display_order || 0))
                    .forEach(method => {
                        methodsDiv.innerHTML += `
                            <div class="payment-item">
                                <label>${method.name}</label>
                                <input type="number" id="payment_${method.id}" placeholder="0" value="0">
                            </div>
                        `;
                    });

            } catch (error) {
                showMessage('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + error.message, 'error');
            }
        }

        // –î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥
        function addExpense() {
            expenseCount++;
            const expensesDiv = document.getElementById('expenses');
            const div = document.createElement('div');
            div.className = 'list-item';
            div.id = `expense_${expenseCount}`;
            
            let options = '<option value="">–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>';
            expenseCategories.forEach(cat => {
                options += `<option value="${cat.id}">${cat.name}</option>`;
            });

            div.innerHTML = `
                <select id="expense_cat_${expenseCount}">${options}</select>
                <input type="number" id="expense_amt_${expenseCount}" placeholder="–°—É–º–º–∞">
                <input type="text" id="expense_desc_${expenseCount}" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ">
                <button class="btn btn-remove" onclick="removeExpense(${expenseCount})">‚úñ</button>
            `;
            expensesDiv.appendChild(div);
        }

        // –£–¥–∞–ª–∏—Ç—å —Ä–∞—Å—Ö–æ–¥
        function removeExpense(id) {
            document.getElementById(`expense_${id}`).remove();
        }

        // –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏—Ö–æ–¥
        function addIncome() {
            incomeCount++;
            const incomesDiv = document.getElementById('incomes');
            const div = document.createElement('div');
            div.className = 'list-item';
            div.id = `income_${incomeCount}`;
            
            let options = '<option value="">–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>';
            incomeCategories.forEach(cat => {
                options += `<option value="${cat.id}">${cat.name}</option>`;
            });

            div.innerHTML = `
                <select id="income_cat_${incomeCount}">${options}</select>
                <input type="number" id="income_amt_${incomeCount}" placeholder="–°—É–º–º–∞">
                <input type="text" id="income_desc_${incomeCount}" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ">
                <button class="btn btn-remove" onclick="removeIncome(${incomeCount})">‚úñ</button>
            `;
            incomesDiv.appendChild(div);
        }

        // –£–¥–∞–ª–∏—Ç—å –ø—Ä–∏—Ö–æ–¥
        function removeIncome(id) {
            document.getElementById(`income_${id}`).remove();
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
        function showMessage(text, type) {
            const msgDiv = document.getElementById('message');
            msgDiv.className = type;
            msgDiv.textContent = text;
            setTimeout(() => msgDiv.textContent = '', 5000);
        }

        // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ç—á—ë—Ç
        async function saveReport() {
            try {
                // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                const reportDate = document.getElementById('reportDate').value;
                const locationId = parseInt(document.getElementById('location').value);
                const totalSales = parseFloat(document.getElementById('totalSales').value);
                const cashActual = parseFloat(document.getElementById('cashActual').value) || 0;

                // –í–∞–ª–∏–¥–∞—Ü–∏—è
                if (!reportDate || !locationId || !totalSales) {
                    showMessage('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è!', 'error');
                    return;
                }

                // –°–æ–±–∏—Ä–∞–µ–º –ø–ª–∞—Ç–µ–∂–∏
                const payments = [];
                paymentMethods.forEach(method => {
                    const amount = parseFloat(document.getElementById(`payment_${method.id}`).value) || 0;
                    if (amount > 0) {
                        payments.push({
                            method_id: method.id,
                            amount: amount
                        });
                    }
                });

                // –°–æ–±–∏—Ä–∞–µ–º —Ä–∞—Å—Ö–æ–¥—ã
                const expenses = [];
                for (let i = 1; i <= expenseCount; i++) {
                    const amtEl = document.getElementById(`expense_amt_${i}`);
                    if (amtEl) {
                        const amount = parseFloat(amtEl.value) || 0;
                        if (amount > 0) {
                            const catId = document.getElementById(`expense_cat_${i}`).value;
                            const desc = document.getElementById(`expense_desc_${i}`).value;
                            expenses.push({
                                category_id: catId ? parseInt(catId) : null,
                                amount: amount,
                                description: desc || '–†–∞—Å—Ö–æ–¥'
                            });
                        }
                    }
                }

                // –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–∏—Ö–æ–¥—ã
                const incomes = [];
                for (let i = 1; i <= incomeCount; i++) {
                    const amtEl = document.getElementById(`income_amt_${i}`);
                    if (amtEl) {
                        const amount = parseFloat(amtEl.value) || 0;
                        if (amount > 0) {
                            const catId = document.getElementById(`income_cat_${i}`).value;
                            const desc = document.getElementById(`income_desc_${i}`).value;
                            incomes.push({
                                category_id: catId ? parseInt(catId) : null,
                                amount: amount,
                                description: desc || '–ü—Ä–∏—Ö–æ–¥'
                            });
                        }
                    }
                }

                // –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å
                const data = {
                    report_date: reportDate,
                    location_id: locationId,
                    total_sales: totalSales,
                    payments: payments,
                    expenses: expenses,
                    incomes: incomes,
                    cash_actual: cashActual,
                    created_by: tg.initDataUnsafe?.user?.username || 'telegram_user'
                };

                console.log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º:', data);

                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                const response = await fetch(`${API_URL}/api/create_report`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (response.ok) {
                    showMessage('‚úÖ –û—Ç—á—ë—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω—ë–Ω!', 'success');
                    tg.showAlert('–û—Ç—á—ë—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω!', () => {
                        tg.close();
                    });
                } else {
                    showMessage('‚ùå ' + result.detail, 'error');
                }

            } catch (error) {
                showMessage('–û—à–∏–±–∫–∞: ' + error.message, 'error');
                console.error(error);
            }
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        loadData();
    </script>
</body>
</html>
