<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üì± –î–Ω–µ–≤–Ω–æ–π –æ—Ç—á—ë—Ç</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--tg-theme-bg-color, #f5f5f5);
            color: var(--tg-theme-text-color, #000);
            padding: 16px;
            padding-bottom: 80px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 24px;
            padding: 16px;
            background: var(--tg-theme-secondary-bg-color, #fff);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .section {
            background: var(--tg-theme-secondary-bg-color, #fff);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--tg-theme-link-color, #2481cc);
        }

        .form-group {
            margin-bottom: 16px;
        }

        label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--tg-theme-hint-color, #999);
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            background: var(--tg-theme-bg-color, #fff);
            color: var(--tg-theme-text-color, #000);
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--tg-theme-button-color, #2481cc);
        }

        .payment-item {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
            padding: 12px;
            background: var(--tg-theme-bg-color, #f9f9f9);
            border-radius: 8px;
        }

        .payment-item label {
            flex: 1;
            margin: 0;
        }

        .payment-item input {
            flex: 2;
            min-width: 120px;
        }

        /* –ö–£–ü–Æ–†–´ */
        .bill-row {
            display: grid;
            grid-template-columns: 1fr 2fr 2fr;
            gap: 8px;
            align-items: center;
            margin-bottom: 8px;
            padding: 8px;
            background: var(--tg-theme-bg-color, #f9f9f9);
            border-radius: 6px;
        }

        .bill-label {
            font-weight: 600;
            font-size: 14px;
        }

        .bill-input {
            padding: 8px !important;
            font-size: 14px !important;
        }

        .bill-total {
            font-weight: 600;
            color: var(--tg-theme-button-color, #2481cc);
            text-align: right;
        }

        /* –ò–¢–û–ì–ò */
        .summary-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 16px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        .summary-row:last-child {
            border-bottom: none;
            font-size: 18px;
            font-weight: bold;
            padding-top: 15px;
        }

        .summary-label {
            font-size: 14px;
        }

        .summary-value {
            font-size: 16px;
            font-weight: 600;
        }

        .difference-positive {
            color: #4ade80;
        }

        .difference-negative {
            color: #f87171;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.3s;
        }

        .btn:active {
            opacity: 0.7;
        }

        .btn-primary {
            background: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #fff);
            width: 100%;
        }

        .btn-add {
            background: #4CAF50;
            color: white;
            width: 100%;
            margin-top: 8px;
        }

        .btn-remove {
            background: #f44336;
            color: white;
            padding: 8px 16px;
            font-size: 14px;
        }

        .info-text {
            font-size: 14px;
            color: var(--tg-theme-hint-color, #999);
            margin-top: 8px;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .success {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .list-item {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            align-items: flex-start;
        }

        .list-item input,
        .list-item select {
            flex: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì± –î–Ω–µ–≤–Ω–æ–π –æ—Ç—á—ë—Ç</h1>
            <p id="dateDisplay"></p>
        </div>

        <div id="message"></div>

        <!-- –ò–¢–û–ì–ò –í –†–ï–ê–õ–¨–ù–û–ú –í–†–ï–ú–ï–ù–ò -->
        <div class="summary-box" id="summaryBox">
            <div class="summary-row">
                <span class="summary-label">üíµ –ù–∞–ª–∏—á–Ω—ã–µ:</span>
                <span class="summary-value" id="cashTotal">0</span>
            </div>
            <div class="summary-row">
                <span class="summary-label">üí≥ –ë–µ–∑–Ω–∞–ª–∏—á–Ω—ã–µ:</span>
                <span class="summary-value" id="cardTotal">0</span>
            </div>
            <div class="summary-row">
                <span class="summary-label">üìä –í—Å–µ–≥–æ –ø—Ä–æ–¥–∞–∂:</span>
                <span class="summary-value" id="totalSales">0</span>
            </div>
            <div class="summary-row">
                <span class="summary-label">‚öñÔ∏è –†–∞–∑–Ω–∏—Ü–∞:</span>
                <span class="summary-value" id="difference">0</span>
            </div>
        </div>

        <!-- –û–°–ù–û–í–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø -->
        <div class="section">
            <div class="section-title">üìã –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</div>
            
            <div class="form-group">
                <label>–î–∞—Ç–∞ –æ—Ç—á—ë—Ç–∞</label>
                <input type="date" id="reportDate" required>
            </div>

            <div class="form-group">
                <label>–¢–æ—á–∫–∞ –ø—Ä–æ–¥–∞–∂</label>
                <select id="location" required>
                    <option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>
                </select>
            </div>

            <div class="form-group">
                <label>–û–±—â–∞—è —Å—É–º–º–∞ –ø—Ä–æ–¥–∞–∂ (—Å—É–º)</label>
                <input type="text" id="totalSalesInput" placeholder="0" required>
            </div>
        </div>

        <!-- –ú–ï–¢–û–î–´ –û–ü–õ–ê–¢–´ -->
        <div class="section">
            <div class="section-title">üí≥ –ú–µ—Ç–æ–¥—ã –æ–ø–ª–∞—Ç—ã</div>
            <div id="paymentMethods"></div>
        </div>

        <!-- –ü–û–î–°–ß–Å–¢ –ù–ê–õ–ò–ß–ù–´–• -->
        <div class="section">
            <div class="section-title">üíµ –ü–æ–¥—Å—á—ë—Ç –Ω–∞–ª–∏—á–Ω—ã—Ö (–∫—É–ø—é—Ä—ã)</div>
            
            <div class="bill-row">
                <div class="bill-label">–ö—É–ø—é—Ä–∞</div>
                <div class="bill-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</div>
                <div class="bill-label">–°—É–º–º–∞</div>
            </div>

            <div class="bill-row">
                <div class="bill-label">200 000</div>
                <input type="text" class="bill-input" id="bill_200000" data-value="200000" placeholder="0">
                <div class="bill-total" id="total_200000">0</div>
            </div>

            <div class="bill-row">
                <div class="bill-label">100 000</div>
                <input type="text" class="bill-input" id="bill_100000" data-value="100000" placeholder="0">
                <div class="bill-total" id="total_100000">0</div>
            </div>

            <div class="bill-row">
                <div class="bill-label">50 000</div>
                <input type="text" class="bill-input" id="bill_50000" data-value="50000" placeholder="0">
                <div class="bill-total" id="total_50000">0</div>
            </div>

            <div class="bill-row">
                <div class="bill-label">20 000</div>
                <input type="text" class="bill-input" id="bill_20000" data-value="20000" placeholder="0">
                <div class="bill-total" id="total_20000">0</div>
            </div>

            <div class="bill-row">
                <div class="bill-label">10 000</div>
                <input type="text" class="bill-input" id="bill_10000" data-value="10000" placeholder="0">
                <div class="bill-total" id="total_10000">0</div>
            </div>

            <div class="bill-row">
                <div class="bill-label">5 000</div>
                <input type="text" class="bill-input" id="bill_5000" data-value="5000" placeholder="0">
                <div class="bill-total" id="total_5000">0</div>
            </div>

            <div class="bill-row">
                <div class="bill-label">1 000</div>
                <input type="text" class="bill-input" id="bill_1000" data-value="1000" placeholder="0">
                <div class="bill-total" id="total_1000">0</div>
            </div>

            <div class="bill-row">
                <div class="bill-label">500</div>
                <input type="text" class="bill-input" id="bill_500" data-value="500" placeholder="0">
                <div class="bill-total" id="total_500">0</div>
            </div>

            <div class="bill-row">
                <div class="bill-label">üí∞ –ú–æ–Ω–µ—Ç—ã</div>
                <input type="text" class="bill-input" id="coins" placeholder="0">
                <div class="bill-total" id="total_coins">0</div>
            </div>

            <div class="bill-row" style="background: #e3f2fd; font-weight: bold;">
                <div>–ò–¢–û–ì–û –ù–ê–õ–ò–ß–ù–´–•:</div>
                <div></div>
                <div class="bill-total" id="cashActualTotal" style="font-size: 18px;">0</div>
            </div>
        </div>

        <!-- –†–ê–°–•–û–î–´ -->
        <div class="section">
            <div class="section-title">üí∏ –†–∞—Å—Ö–æ–¥—ã</div>
            <div id="expenses"></div>
            <button class="btn btn-add" onclick="addExpense()">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥</button>
        </div>

        <!-- –ü–†–ò–•–û–î–´ -->
        <div class="section">
            <div class="section-title">üí∞ –ü—Ä–∏—Ö–æ–¥—ã (–Ω–µ –æ—Ç –ø—Ä–æ–¥–∞–∂)</div>
            <div id="incomes"></div>
            <button class="btn btn-add" onclick="addIncome()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏—Ö–æ–¥</button>
        </div>

        <!-- –ö–ù–û–ü–ö–ê –°–û–•–†–ê–ù–ï–ù–ò–Ø -->
        <button class="btn btn-primary" onclick="saveReport()">üíæ –°–û–•–†–ê–ù–ò–¢–¨ –û–¢–ß–Å–¢</button>
    </div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        const tg = window.Telegram?.WebApp || {
            expand: () => {},
            ready: () => {},
            showAlert: (msg, callback) => { alert(msg); callback?.(); },
            close: () => { console.log('Close'); },
            initDataUnsafe: {}
        };
        tg.expand();
        tg.ready();

        // API URL
        const API_URL = 'https://web-production-8396.up.railway.app';

        // –î–∞–Ω–Ω—ã–µ
        let locations = [];
        let paymentMethods = [];
        let expenseCategories = [];
        let incomeCategories = [];
        let expenseCount = 0;
        let incomeCount = 0;

        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–∏—Å–ª–∞ —Å –ø—Ä–æ–±–µ–ª–∞–º–∏
        function formatNumber(num) {
            if (!num) return '';
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
        }

        // –£–±—Ä–∞—Ç—å –ø—Ä–æ–±–µ–ª—ã –∏–∑ —á–∏—Å–ª–∞
        function unformatNumber(str) {
            return str.replace(/\s/g, '');
        }

        // –í–∞–ª–∏–¥–∞—Ü–∏—è - —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã
        function validateNumberInput(event) {
            const input = event.target;
            let value = input.value.replace(/[^\d]/g, '');
            input.value = value;
            return value;
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞ —Å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
        function handleNumberInput(event) {
            const input = event.target;
            let value = unformatNumber(input.value);
            value = value.replace(/[^\d]/g, '');
            if (value) {
                input.value = formatNumber(value);
            } else {
                input.value = '';
            }
            calculateTotals();
        }

        // –†–∞—Å—á—ë—Ç –∏—Ç–æ–≥–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
        function calculateTotals() {
            // –ü–æ–¥—Å—á—ë—Ç –Ω–∞–ª–∏—á–Ω—ã—Ö (–∫—É–ø—é—Ä—ã)
            let cashActual = 0;
            const bills = [200000, 100000, 50000, 20000, 10000, 5000, 1000, 500];
            
            bills.forEach(bill => {
                const input = document.getElementById(`bill_${bill}`);
                const count = parseInt(unformatNumber(input.value)) || 0;
                const total = count * bill;
                cashActual += total;
                document.getElementById(`total_${bill}`).textContent = formatNumber(total);
            });

            // –ú–æ–Ω–µ—Ç—ã
            const coinsInput = document.getElementById('coins');
            const coins = parseInt(unformatNumber(coinsInput.value)) || 0;
            cashActual += coins;
            document.getElementById('total_coins').textContent = formatNumber(coins);

            // –ò—Ç–æ–≥–æ –Ω–∞–ª–∏—á–Ω—ã—Ö
            document.getElementById('cashActualTotal').textContent = formatNumber(cashActual);

            // –ë–µ–∑–Ω–∞–ª (–≤—Å–µ –º–µ—Ç–æ–¥—ã –æ–ø–ª–∞—Ç—ã)
            let cardTotal = 0;
            paymentMethods.forEach(method => {
                const input = document.getElementById(`payment_${method.id}`);
                if (input) {
                    const amount = parseInt(unformatNumber(input.value)) || 0;
                    cardTotal += amount;
                }
            });

            // –û–±—â–∞—è —Å—É–º–º–∞ –ø—Ä–æ–¥–∞–∂
            const totalSalesInput = document.getElementById('totalSalesInput');
            const totalSales = parseInt(unformatNumber(totalSalesInput.value)) || 0;

            // –†–∞–∑–Ω–∏—Ü–∞
            const difference = cashActual - (totalSales - cardTotal);

            // –û–±–Ω–æ–≤–∏—Ç—å –±–ª–æ–∫ –∏—Ç–æ–≥–æ–≤
            document.getElementById('cashTotal').textContent = formatNumber(cashActual);
            document.getElementById('cardTotal').textContent = formatNumber(cardTotal);
            document.getElementById('totalSales').textContent = formatNumber(totalSales);
            
            const diffElement = document.getElementById('difference');
            diffElement.textContent = formatNumber(Math.abs(difference));
            if (difference > 0) {
                diffElement.className = 'summary-value difference-positive';
                diffElement.textContent = '+' + formatNumber(difference);
            } else if (difference < 0) {
                diffElement.className = 'summary-value difference-negative';
                diffElement.textContent = '-' + formatNumber(Math.abs(difference));
            } else {
                diffElement.className = 'summary-value';
                diffElement.textContent = '0';
            }
        }

        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–µ–∫—É—â–µ–π –¥–∞—Ç—ã
        document.getElementById('reportDate').valueAsDate = new Date();
        document.getElementById('dateDisplay').textContent = new Date().toLocaleDateString('ru-RU');

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        async function loadData() {
            try {
                const [locsRes, methodsRes, expCatsRes, incCatsRes] = await Promise.all([
                    fetch(`${API_URL}/api/locations`),
                    fetch(`${API_URL}/api/payment_methods`),
                    fetch(`${API_URL}/api/expense_categories`),
                    fetch(`${API_URL}/api/income_categories`)
                ]);

                locations = (await locsRes.json()).data;
                paymentMethods = (await methodsRes.json()).data;
                expenseCategories = (await expCatsRes.json()).data;
                incomeCategories = (await incCatsRes.json()).data;

                // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ç–æ—á–∫–∏
                const locSelect = document.getElementById('location');
                locSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—á–∫—É</option>';
                locations.forEach(loc => {
                    locSelect.innerHTML += `<option value="${loc.id}">${loc.name}</option>`;
                });

                // –ó–∞–ø–æ–ª–Ω—è–µ–º –º–µ—Ç–æ–¥—ã –æ–ø–ª–∞—Ç—ã (—Ç–æ–ª—å–∫–æ –≤–∏–¥–∏–º—ã–µ, –ø–æ –ø–æ—Ä—è–¥–∫—É)
                const methodsDiv = document.getElementById('paymentMethods');
                paymentMethods
                    .filter(m => m.is_visible && m.is_active)
                    .sort((a, b) => (a.display_order || 0) - (b.display_order || 0))
                    .forEach(method => {
                        methodsDiv.innerHTML += `
                            <div class="payment-item">
                                <label>${method.name}</label>
                                <input type="text" id="payment_${method.id}" placeholder="" oninput="handleNumberInput(event)">
                            </div>
                        `;
                    });

                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫—É–ø—é—Ä
                const bills = [200000, 100000, 50000, 20000, 10000, 5000, 1000, 500];
                bills.forEach(bill => {
                    const input = document.getElementById(`bill_${bill}`);
                    input.addEventListener('input', handleNumberInput);
                });

                document.getElementById('coins').addEventListener('input', handleNumberInput);
                document.getElementById('totalSalesInput').addEventListener('input', handleNumberInput);

            } catch (error) {
                showMessage('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + error.message, 'error');
            }
        }

        // –î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥
        function addExpense() {
            expenseCount++;
            const expensesDiv = document.getElementById('expenses');
            const div = document.createElement('div');
            div.className = 'list-item';
            div.id = `expense_${expenseCount}`;
            
            let options = '<option value="">–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>';
            expenseCategories.forEach(cat => {
                options += `<option value="${cat.id}">${cat.name}</option>`;
            });

            div.innerHTML = `
                <select id="expense_cat_${expenseCount}">${options}</select>
                <input type="text" id="expense_amt_${expenseCount}" placeholder="–°—É–º–º–∞" oninput="validateNumberInput(event)">
                <input type="text" id="expense_desc_${expenseCount}" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ">
                <button class="btn btn-remove" onclick="removeExpense(${expenseCount})">‚úñ</button>
            `;
            expensesDiv.appendChild(div);
        }

        function removeExpense(id) {
            document.getElementById(`expense_${id}`).remove();
        }

        // –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏—Ö–æ–¥
        function addIncome() {
            incomeCount++;
            const incomesDiv = document.getElementById('incomes');
            const div = document.createElement('div');
            div.className = 'list-item';
            div.id = `income_${incomeCount}`;
            
            let options = '<option value="">–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>';
            incomeCategories.forEach(cat => {
                options += `<option value="${cat.id}">${cat.name}</option>`;
            });

            div.innerHTML = `
                <select id="income_cat_${incomeCount}">${options}</select>
                <input type="text" id="income_amt_${incomeCount}" placeholder="–°—É–º–º–∞" oninput="validateNumberInput(event)">
                <input type="text" id="income_desc_${incomeCount}" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ">
                <button class="btn btn-remove" onclick="removeIncome(${incomeCount})">‚úñ</button>
            `;
            incomesDiv.appendChild(div);
        }

        function removeIncome(id) {
            document.getElementById(`income_${id}`).remove();
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
        function showMessage(text, type) {
            const msgDiv = document.getElementById('message');
            msgDiv.className = type;
            msgDiv.textContent = text;
            setTimeout(() => msgDiv.textContent = '', 5000);
        }

        // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ç—á—ë—Ç
        async function saveReport() {
            try {
                const reportDate = document.getElementById('reportDate').value;
                const locationId = parseInt(document.getElementById('location').value);
                const totalSales = parseInt(unformatNumber(document.getElementById('totalSalesInput').value)) || 0;

                if (!reportDate || !locationId || !totalSales) {
                    showMessage('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è!', 'error');
                    return;
                }

                // –°–æ–±–∏—Ä–∞–µ–º –ø–ª–∞—Ç–µ–∂–∏
                const payments = [];
                paymentMethods
                    .filter(m => m.is_visible && m.is_active)
                    .forEach(method => {
                        const amount = parseInt(unformatNumber(document.getElementById(`payment_${method.id}`).value)) || 0;
                        if (amount > 0) {
                            payments.push({
                                method_id: method.id,
                                amount: amount
                            });
                        }
                    });

                // –°–æ–±–∏—Ä–∞–µ–º —Ä–∞—Å—Ö–æ–¥—ã
                const expenses = [];
                for (let i = 1; i <= expenseCount; i++) {
                    const amtEl = document.getElementById(`expense_amt_${i}`);
                    if (amtEl) {
                        const amount = parseInt(unformatNumber(amtEl.value)) || 0;
                        if (amount > 0) {
                            const catId = document.getElementById(`expense_cat_${i}`).value;
                            const desc = document.getElementById(`expense_desc_${i}`).value;
                            expenses.push({
                                category_id: catId ? parseInt(catId) : null,
                                amount: amount,
                                description: desc || '–†–∞—Å—Ö–æ–¥'
                            });
                        }
                    }
                }

                // –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–∏—Ö–æ–¥—ã
                const incomes = [];
                for (let i = 1; i <= incomeCount; i++) {
                    const amtEl = document.getElementById(`income_amt_${i}`);
                    if (amtEl) {
                        const amount = parseInt(unformatNumber(amtEl.value)) || 0;
                        if (amount > 0) {
                            const catId = document.getElementById(`income_cat_${i}`).value;
                            const desc = document.getElementById(`income_desc_${i}`).value;
                            incomes.push({
                                category_id: catId ? parseInt(catId) : null,
                                amount: amount,
                                description: desc || '–ü—Ä–∏—Ö–æ–¥'
                            });
                        }
                    }
                }

                // –ü–æ–¥—Å—á—ë—Ç –Ω–∞–ª–∏—á–Ω—ã—Ö
                let cashActual = 0;
                const bills = [200000, 100000, 50000, 20000, 10000, 5000, 1000, 500];
                bills.forEach(bill => {
                    const input = document.getElementById(`bill_${bill}`);
                    const count = parseInt(unformatNumber(input.value)) || 0;
                    cashActual += count * bill;
                });
                cashActual += parseInt(unformatNumber(document.getElementById('coins').value)) || 0;

                // –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å
                const data = {
                    report_date: reportDate,
                    location_id: locationId,
                    total_sales: totalSales,
                    payments: payments,
                    expenses: expenses,
                    incomes: incomes,
                    cash_actual: cashActual,
                    created_by: tg.initDataUnsafe?.user?.username || 'telegram_user'
                };

                console.log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º:', data);

                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                const response = await fetch(`${API_URL}/api/create_report`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (response.ok) {
                    showMessage('‚úÖ –û—Ç—á—ë—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω—ë–Ω!', 'success');
                    tg.showAlert('–û—Ç—á—ë—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω!', () => {
                        tg.close();
                    });
                } else {
                    showMessage('‚ùå ' + result.detail, 'error');
                }

            } catch (error) {
                showMessage('–û—à–∏–±–∫–∞: ' + error.message, 'error');
                console.error(error);
            }
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        loadData();
    </script>
</body>
</html>
